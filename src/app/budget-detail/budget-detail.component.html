<div [formGroup]="baseAmountForm">
  <div
    class="mx-auto my-auto w-1/3 p-3 gap-y-2 grid grid-col-1 ssm:w-full sm:w-3/4 xl:w-1/3"
  >
    <div class="flex justify-between">
      <button
        type="button"
        (click)="goHome()"
        class="flex items-center justify-center w-1/4 ssm:w-2/5 px-5 ssm:px-0 py-2 text-sm text-gray-700 transition-colors duration-200 bg-purple-300 border rounded-md gap-x-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="#5f6368"
        >
          <path
            d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"
          />
        </svg>
        <span>Home</span>
      </button>
      <div
        class="flex flex-row items-center justify-center w-1/3 py-2 text-sm text-gray-700 transition-colors duration-200 font-bold gap-x-2"
      >
        <span>{{ budget().name }}</span>
      </div>
      <button
        type="button"
        (click)="goToViewBudgets()"
        class="flex items-center justify-center w-1/4 ssm:w-2/5 px-5 ssm:px-0 py-2 text-sm text-gray-700 transition-colors duration-200 bg-purple-300 border rounded-md gap-x-2"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="#5f6368"
        >
          <path
            d="M200-120q-33 0-56.5-23.5T120-200v-640h80v640h640v80H200Zm40-120v-360h160v360H240Zm200 0v-560h160v560H440Zm200 0v-200h160v200H640Z"
          />
        </svg>
        <span>View Budgets</span>
      </button>
    </div>
    <input
      [currencyMask]="{
        prefix: '',
        thousands: ',',
        decimal: '.',
        align: 'center'
      }"
      formControlName="baseAmount"
      (keyup)="onBaseAmountChange($event)"
      type="text"
      class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
      placeholder="Base Amount"
    />
  </div>
  <div
    class="mx-auto my-auto w-1/3 grid grid-cols-1 gap-5 p-3 ssm:w-full sm:w-3/4 xl:w-1/3"
  >
    <button
      mat-raised-button
      [disabled]="!baseAmountForm.valid"
      (click)="addBudgetItem()"
      color="primary"
    >
      Add Item
    </button>
  </div>
</div>

<div
  [formGroup]="budgetItemsForm"
  class="mx-auto my-auto w-1/3 p-3 ssm:w-full sm:w-3/4 xl:w-1/3 relative sm:rounded-lg overflow-clip flex flex-col h-96 ssm:h-[400px] md:h-[500px] sm:h-[500px] xl:h-[400px] lg:h-[400px]"
>
  @if(itemControls.controls.length > 0){
  <table
    class="w-full text-sm text-left rtl:text-right table-fixed mb-5 border-2 rounded-lg bg-purple-100"
  >
    <thead class="text-xs uppercase sticky top-0 text-center">
      <tr>
        <th class="px-6 py-3">Budgeted</th>
        <th class="px-6 py-3 ssm:text-">(%)</th>
        <th class="px-6 py-3">Balance</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr>
        <td class="px-6 py-3">{{ amountSum() | number : "1.1-2" }}</td>
        <td class="px-6 py-3 ssm:text-">
          {{
            percentageSum() > 100 ? 0 : (percentageSum() | number : "1.1-2")
          }}&nbsp;%
        </td>
        <td class="px-6 py-3">
          {{
            amountSum() >= budget().baseAmount
              ? 0
              : (balance() | number : "1.1-2")
          }}
        </td>
      </tr>
    </tbody>
  </table>
  <div class="flex-1 overflow-y-auto">
    <table class="w-full table-fixed">
      <tbody class="" formArrayName="items">
        @for(item of itemControls.controls; track item; let i = $index){
        <tr [formGroupName]="i" class="border-b px-6 py-3">
          <td>
            <input
              formControlName="budgetItem"
              type="text"
              class="w-full py-2 px-3"
              placeholder="Item Name"
            />
          </td>
          <td class="">
            <input
              [currencyMask]="{
                prefix: '',
                thousands: ',',
                decimal: '.',
                align: 'center'
              }"
              [disabled]="!budgetItemsForm.valid"
              (keyup)="calculatePercentage(item.get('budgetItem')?.value)"
              formControlName="amount"
              type="text"
              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              placeholder="0.00"
            />
          </td>
          <td class="text-center">
            <!-- {{ (item.get("amount")?.value - 0 / budget.baseAmount) * 100 }}% -->
            {{
              (item.get("amount")?.value / budget().baseAmount) * 100 > 100
                ? 0
                : ((
                    (item.get("amount")?.value / budget().baseAmount) *
                    100
                  ).toFixed(2) | number : "1.1-2")
            }}%
          </td>
          <td class="px-6 py-4">
            <button
              (click)="deleteItem(item.get('budgetItem')?.value)"
              class="font-medium text-blue-600 dark:text-blue-500 hover:underline"
              mat-button
              color="warn"
            >
              Delete
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  @if(!newBudget){
  <div class="flex justify-between">
    <button
      [hidden]="newBudget"
      mat-raised-button
      (click)="deleteBudget()"
      class="right-0"
      color="warn"
    >
      Delete Budget
    </button>
    <button
      mat-raised-button
      (click)="updateBudget()"
      class="right-0"
      color="primary"
    >
      Update Budget
    </button>
  </div>
  } @if(newBudget){
  <button
    mat-raised-button
    (click)="saveNewBudget()"
    color="primary"
    class="w-full"
  >
    Save Budget
  </button>
  } }
</div>
